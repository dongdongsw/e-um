<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eum.main.mapper.talent-mapper">

  <resultMap type="com.eum.main.vo.BoardVO" id="boardMap">
  	<result property="rvo.b_review_score" column="b_review_score"/>
  	<result property="rvo.u_s_id" column="u_s_id"/>
	<result property="rvo.b_review_id" column="b_review_id"/>
	<result property="rvo.b_review_createdat" column="b_review_createdat"/>
	<result property="rvo.b_review_content" column="b_review_content"/>
	<result property="rvo.review_count" column="review_count"/>
	<result property="rvo.group_id" column="group_id"/>
	<result property="rvo.root" column="root"/>
	<result property="rvo.depth" column="depth"/>
	<result property="rvo.reply" column="reply"/>
  	<result property="bovo.b_op_price" column="b_op_price"/>
  	<result property="bivo.b_img_url" column="b_img_url"/>
  	<result property="usvo.u_s_com" column="u_s_com"/>
	<result property="usvo.u_s_profileimg_url" column="u_s_profileimg_url"/>
	<result property="usvo.u_s_carrer" column="u_s_carrer"/>
	<result property="usvo.u_s_zone" column="u_s_zone"/>
	<result property="uvo.u_id" column="u_id"/>
	<result property="uvo.u_nickname" column="u_nickname"/>
	<result property="uvo.u_profileimg_url" column="u_profileImg_url"/>
  </resultMap>
  
<!-- 리스트(정렬, 페이징, 키워드, 검색) -->
<select id="contentList" parameterType="hashmap" resultMap="boardMap">
  SELECT *
  FROM (
      SELECT a.*, ROWNUM AS num
      FROM (
          SELECT 
              b.b_id,
              b.b_title,
              b.b_type,
              b.b_thumbnail,
              b.b_view_count,
              r.b_review_score,
              r.review_count,
              o.b_op_price,
              u.u_s_com
          FROM board b
          LEFT JOIN (
              SELECT b_id,
                     ROUND(AVG(b_review_score),1) AS b_review_score,
                     COUNT(*) AS review_count
              FROM review
              WHERE depth = 1
              GROUP BY b_id
          ) r ON b.b_id = r.b_id
          LEFT JOIN (
              SELECT b_id,
                     MIN(b_op_price) AS b_op_price
              FROM board_option
              GROUP BY b_id
          ) o ON b.b_id = o.b_id
          LEFT JOIN users_seller u ON b.u_s_id = u.u_s_id
          
               WHERE 1=1
              <if test="b_type != null and b_type != ''">
                AND b.b_type = #{b_type}
              </if>
              <if test="keyword != null and keyword != ''">
            	AND b.b_title LIKE '%' || #{keyword} || '%'
        	</if>
          <choose>
            <when test="sort == 'view'">
              ORDER BY b.b_view_count DESC
            </when>
            <when test="sort == 'review_score'">
              ORDER BY NVL(r.b_review_score, 0) DESC
            </when>
            <when test="sort == 'price_asc'">
              ORDER BY NVL(o.b_op_price, 999999999) ASC
            </when>
            <when test="sort == 'price_desc'">
              ORDER BY NVL(o.b_op_price, 0) DESC
            </when>
            <when test="sort == 'review'">
              ORDER BY NVL(r.review_count, 0) DESC
            </when>
            <otherwise>
              ORDER BY b.b_id DESC
            </otherwise>
          </choose>
      ) a
  )
  WHERE num BETWEEN #{start} AND #{end}
</select>

<!-- 통합 총페이지 -->
<select id="contentTotalPage" parameterType="hashmap" resultType="int">
  SELECT CEIL(COUNT(*) / 12.0)
  FROM board b
      WHERE 1=1
      <if test="b_type != null and b_type != ''">
        AND b.b_type = #{b_type}
      </if>
      <if test="keyword != null and keyword != ''">
            AND b.b_title LIKE '%' || #{keyword} || '%'
        </if>
</select>

  
  <!-- 게시판 -->
  <select id="talentDetailData" resultType="BoardVO" parameterType="string">
    SELECT * FROM board
    WHERE b_id=#{b_id}
  </select>
  
  <!-- 디테일 페이지 -->
  
  <!-- 상세보기 -->
  <select id="talentDetailboard" resultMap="boardMap" parameterType="string">
	SELECT 
	b.b_id,
	b.b_thumbnail,
	b.b_title,
	b.b_type,
	b.b_view_count,
	b.b_content,
	b.b_prod_on_off,
	b.u_s_id,
	(SELECT COUNT(*) FROM review re WHERE re.b_id = b.b_id) AS review_count,
	(SELECT COUNT(*) FROM board_like bl WHERE bl.b_id = b.b_id) AS l_count,
	sel.u_s_com,
	sel.u_s_zone,
	sel.u_s_carrer,
	sel.u_s_profileimg_url
	FROM board b
	LEFT JOIN users_seller sel
	ON b.u_s_id = sel.u_s_id
	WHERE b.b_id = #{b_id}
  </select>
  
  <!-- 상세보기 이미지 -->
  <select id="talentDetailboardImage" resultMap="boardMap" parameterType="string">
    SELECT b_img_url 
	FROM board_image 
	WHERE b_id = #{b_id}
	ORDER BY b_img_id ASC
  </select>

   <!-- review -->
  <select id="talentDetailreview" resultMap="boardMap" parameterType="string">
	  SELECT 
        u.u_id,
        r.root,
        r.depth,
        r.group_id,
        r.b_review_score,
        b.b_id AS b_id,
        r.u_s_id AS u_s_id,
        r.b_review_id AS b_review_id,
        r.b_review_createdat,
        r.b_review_content,
        u.u_nickname,
        u.u_profileimg_url,
        (
            SELECT COUNT(*)
            FROM review r2
            WHERE r2.group_id = r.group_id
              AND r2.depth = 2
        ) AS reply
    FROM review r
    JOIN board  b ON b.b_id = r.b_id
    JOIN users  u ON r.u_id = u.u_id
    WHERE b.b_id = #{b_id}
    ORDER BY
        r.group_id DESC,
        r.depth ASC,
        r.b_review_createdat ASC       

  </select>
  
    <!-- 리뷰 이미지 -->
	<select id="reviewImage" resultType="string" parameterType="string">
	   SELECT r_image_url
	    FROM review_image
	    WHERE b_review_id = #{b_review_id}
	    ORDER BY r_image_id ASC
	</select>
  
  <!-- 별점 평균 -->
  <select id="talentDetailscore" resultMap="boardMap" parameterType="string">
    SELECT b_id,ROUND(AVG(b_review_score),1) AS b_review_score
	FROM review
	WHERE b_id=#{b_id}
	GROUP BY b_id
  </select>
  
  <!-- 금액 옵션 -->
  <select id="talentDetailprice" resultType="Board_OptionVO" parameterType="string">
    SELECT * FROM board_option
    WHERE b_id=#{b_id}
  </select>
  
  <!-- 조회수 -->
  <update id="talentHitIncrement" parameterType="string">
    UPDATE board SET
    b_view_count=b_view_count+1 
    WHERE b_id=#{b_id}
   </update>
   
  
   <!-- 키워드 검색 -->
   <select id="talentSearchKeywordData" resultMap="boardMap" parameterType="hashmap">
	SELECT * FROM (
	  SELECT ROWNUM AS num, A.*
	  FROM (
	    SELECT
	      board.b_id,
	      b_title,
	      b_thumbnail,
	      ROUND(AVG(b_review_score),1) AS b_review_score,
	      COUNT(DISTINCT b_review_id) AS review_count,
	      MIN(b_op_price) AS b_op_price,
	      u_s_com,
	      b_type,
	      board.b_view_count
	    FROM board
	    JOIN board_option ON board.b_id = board_option.b_id
	    JOIN users_seller ON board.u_s_id = users_seller.u_s_id
	    JOIN review ON board.b_id = review.b_id
	    WHERE (b_title LIKE '%'||#{keyword}||'%'
	       OR b_content LIKE '%'||#{keyword}||'%')
	    GROUP BY board.b_id,b_title,b_thumbnail,u_s_com,b_type,board.b_view_count
	    <choose>
	      <when test="fd == 'price_asc'">ORDER BY b_op_price ASC</when>
	      <when test="fd == 'price_desc'">ORDER BY b_op_price DESC</when>
	      <when test="fd == 'review'">ORDER BY review_count DESC</when>
	      <when test="fd == 'view'">ORDER BY board.b_view_count DESC</when>
	      <when test="fd == 'review_score'">ORDER BY b_review_score DESC</when>
	      <otherwise>ORDER BY board.b_id DESC</otherwise>
	    </choose>
	  ) A
	)
	WHERE num BETWEEN #{start} AND #{end}
</select>
<!-- 키워드 페이지네이션 -->
<select id="talentSearchKeywordTotalPage" resultType="int" parameterType="hashmap">
    SELECT CEIL(COUNT(DISTINCT B.b_id) / 12.0)
    FROM board B
    WHERE B.b_title LIKE '%'||#{keyword}||'%' OR B.b_content LIKE '%'||#{keyword}||'%'
    </select>
    
  <!-- 타입별 리스트 -->
  <!-- 생활라이프 -->
  <select id="talentTypeListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '생활라이프'
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 운동건강 -->
  <select id="exerTypeListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '운동건강'
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 취미/자기개발 -->
  <select id="hobbyTypeListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '취미/자기개발'
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 비즈니스 -->
  <select id="bizTypeListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '비즈니스'
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>

  <!-- 기타 -->
  <select id="etcTypeListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '기타'
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- All -->
  <select id="allTypeListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 타입 페이지네이션 -->
  <!-- 생활라이프 -->
  <select id="talentTypeTotalPage" resultType="int">
    SELECT CEIL(COUNT(*) / 12.0)
    FROM board
    WHERE b_type = '생활라이프'
  </select>
  
  <!-- 운동건강 -->
  <select id="exerTypeTotalPage" resultType="int">
    SELECT CEIL(COUNT(*) / 12.0)
    FROM board
    WHERE b_type = '운동건강'
  </select>
  
  <!-- 취미/자기개발 -->
  <select id="hobbyTypeTotalPage" resultType="int">
    SELECT CEIL(COUNT(*) / 12.0)
    FROM board
    WHERE b_type = '취미/자기개발'
  </select>
  
  <!-- 비즈니스 -->
  <select id="bizTypeTotalPage" resultType="int">
    SELECT CEIL(COUNT(*) / 12.0)
    FROM board
    WHERE b_type = '비즈니스'
  </select>
  
  <!-- 기타 -->
  <select id="etcTypeTotalPage" resultType="int">
    SELECT CEIL(COUNT(*) / 12.0)
    FROM board
    WHERE b_type = '기타'
  </select>
  
  <!-- All -->
  <select id="allTypeTotalPage" resultType="int">
    SELECT CEIL(COUNT(*) / 12.0)
    FROM board
  </select>
  
    <!-- 타입 검색 -->
	<select id="talentSearchTypeData" resultMap="boardMap" parameterType="hashmap">
		SELECT *
    FROM (
        SELECT ROWNUM AS num, A.*
        FROM (
            SELECT b.b_id, b.b_title, b.b_thumbnail, b.b_type, b.b_op_price,
                   u.u_s_com,
                   ROUND(NVL(r.b_review_score, 0), 1) AS b_review_score,
                   NVL(r.review_count, 0) AS review_count
            FROM board b
            LEFT JOIN users u ON b.u_id = u.u_id
            LEFT JOIN (
                SELECT b_id, AVG(b_review_score) AS b_review_score, COUNT(*) AS review_count
                FROM b_review
                GROUP BY b_id
            ) r ON b.b_id = r.b_id
            WHERE b.b_type = #{b_type}
            ORDER BY 
                <choose>
                    <when test="sort == 'view'">b_view_count DESC</when>
                    <when test="sort == 'review_score'">b_review_score DESC</when>
                    <when test="sort == 'price_asc'">b_op_price ASC</when>
                    <when test="sort == 'price_desc'">b_op_price DESC</when>
                    <when test="sort == 'review'">review_count DESC</when>
                    <otherwise>b_id DESC</otherwise>
                </choose>
        ) A
    ) 
    WHERE num BETWEEN #{start} AND #{end}
	</select>
	
	<!-- 타입별 필터 리스트 -->
  <!-- 생활라이프 -->
  <select id="talentFilterListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '생활라이프'
            AND b.b_filter = #{b_filter}
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 운동건강 -->
  <select id="exerFilterListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '운동건강'
            AND b.b_filter = #{b_filter}
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 취미/자기개발 -->
  <select id="hobbyFilterListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '취미/자기개발'
            AND b.b_filter = #{b_filter}
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  
  <!-- 비즈니스 -->
  <select id="bizFilterListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '비즈니스'
            AND b.b_filter = #{b_filter}
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>

  <!-- 기타 -->
  <select id="etcFilterListData" resultMap="boardMap" parameterType="hashmap">
    SELECT * FROM (
        SELECT ROWNUM AS num, B.*
        FROM (
            SELECT 
                b.b_id AS b_id,
                b.b_title AS b_title,
                b.b_thumbnail AS b_thumbnail,
                ROUND(AVG(r.b_review_score), 1) AS b_review_score,
                COUNT(DISTINCT r.b_review_id) AS review_count,
                MIN(bo.b_op_price) AS b_op_price,
                us.u_s_com AS u_s_com,
                b.b_type AS b_type
            FROM board b
            LEFT JOIN board_option bo ON b.b_id = bo.b_id
            LEFT JOIN users_seller us ON b.u_s_id = us.u_s_id
            LEFT JOIN review r ON b.b_id = r.b_id
            WHERE b.b_type = '기타'
            AND b.b_filter = #{b_filter}
            GROUP BY b.b_id, b.b_title, b.b_thumbnail, us.u_s_com, b.b_type
            ORDER BY b.b_id DESC
        ) B
    )
    WHERE num BETWEEN #{start} AND #{end}
  </select>
  <!-- 소카테고리 총페이지 -->
  <select id="filterTotalPage" resultType="int" parameterType="hashmap">
    SELECT CEIL(COUNT(*)/12.0)
    FROM board
    WHERE b_filter = #{b_filter}
  </select>
  
	<!-- 타입 페이지네이션 -->
	<select id="talentSearchTypeTotalPage" resultType="int" parameterType="hashmap">
	    SELECT CEIL(COUNT(*) / 12.0)
	    FROM board
	    WHERE b_type = #{b_type}
	</select>
	
</mapper>

