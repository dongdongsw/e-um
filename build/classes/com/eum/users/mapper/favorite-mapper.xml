<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eum.users.mapper.favorite-mapper">
  <!-- 즐겨찾기 여부 -->
  <select id="favoriteCheckCount" resultType="int" parameterType="FavoriteVO">
    SELECT COUNT(*)
    FROM favorite
    WHERE u_id=#{u_id} AND b_id=#{b_id}
  </select>
  
  <!-- 즐겨찾기 추가 -->
  <insert id="favoriteInsert" parameterType="FavoriteVO">
    INSERT INTO favorite
    VALUES(fv_id_seq.nextval, #{u_id}, #{b_id}, SYSDATE)
  </insert>
  
  <resultMap type="FavoriteVO" id="favoriteMap">
    <result property="bvo.b_type" column="b_type"/>
    <result property="bvo.b_title" column="b_title"/>
    <result property="bvo.b_thumbnail" column="b_thumbnail"/>    
    <result property="usvo.u_s_com" column="u_s_com"/>
    <result property="rvo.b_review_avg" column="b_review_avg"/>
    <result property="rvo.review_count" column="review_count"/>
  </resultMap>
  
  <!-- 즐겨찾기 리스트 -->
  <select id="favoriteListData" resultMap="favoriteMap" parameterType="string">
    SELECT f.fv_id, f.u_id, f.b_id, TO_CHAR(f.fv_pushat, 'YYYY-MM-DD') AS dbday,
    		b.b_type, b.b_title, b.b_thumbnail, us.u_s_com,
    		(SELECT TRUNC(AVG(r.b_review_score), 1)
    		FROM review r
    		WHERE r.b_id=f.b_id) AS b_review_avg,
    			(SELECT COUNT(*)
    			FROM review sub_r
    			WHERE sub_r.b_id=f.b_id) AS review_count
    FROM favorite f
    JOIN board b ON f.b_id=b.b_id
    JOIN users_seller us ON b.u_s_id=us.u_s_id
    WHERE f.u_id=#{u_id}
    GROUP BY f.fv_id, f.u_id, f.b_id, f.fv_pushat, b.b_type,
    		b.b_title, b.b_thumbnail, us.u_s_com
    ORDER BY f.fv_pushat DESC
  </select>
  
  <!-- 즐겨찾기 삭제 -->
  <delete id="favoriteDelete" parameterType="int">
    DELETE FROM favorite
    WHERE fv_id=#{fv_id}
  </delete>
</mapper>